import{S as v,P as b,A as M,d as y}from"./AuthorizationModal-dyv23B9f.js";import{addNotification as u}from"./NotificationMessage-C4XNElNF.js";import{_ as N,r as p,o as l,c as d,a as D,b as r,t as S,w as m,F as C,d as _,e as R,f as P,n as k}from"./index-N29KKT5C.js";const E={name:"CalendarComponent",emits:["update-editing-mode"],components:{ShiftCountWindow:v,PeopleListWindow:b,AuthorizationModal:M},props:{isEditingMode:{type:Boolean,required:!0}},data(){return{selectedMonth:new Date().getMonth(),selectedYear:new Date().getFullYear(),monthDays:[],localData:{},syncedChanges:{},daysOfWeek:y,currentDate:new Date,people:[{id:1,name:"Milena",ratownik:!1},{id:2,name:"Mikołaj",ratownik:!1},{id:3,name:"Aleksandra",ratownik:!1},{id:4,name:"Łukasz",ratownik:!0},{id:5,name:"Joanna",ratownik:!1},{id:6,name:"Natalia",ratownik:!0},{id:7,name:"Marcin",ratownik:!0},{id:8,name:"Alina",ratownik:!1},{id:9,name:"Ewelina",ratownik:!1},{id:7,name:"Teresa",ratownik:!1}],madeChanges:!1,showPasswordModal:!1,password:"",locale:"pl",scrollContainer:null}},computed:{monthYear(){return new Date(this.selectedYear,this.selectedMonth).toLocaleString(this.locale,{month:"long",year:"numeric"})}},methods:{handleDrop(n,e){const a=JSON.parse(localStorage.getItem("draggedPerson"));if(!a)return;const h=this.monthDays.find(f=>f.date.toDateString()===n.toDateString()),i={...h,[e]:a.id};if(i.dayShift1!=null&&i.dayShift2!=null&&i.dayShift1===i.dayShift2||i.nightShift1!=null&&i.nightShift2!=null&&i.nightShift1===i.nightShift2){u("Ta sama osoba na obydwu zmianach.","red");return}const o=a.ratownik;let s=!1;switch(e){case"dayShift1":s=h.dayShift2Ratownik;break;case"dayShift2":s=h.dayShift1Ratownik;break;case"nightShift1":s=h.nightShift2Ratownik;break;case"nightShift2":s=h.nightShift1Ratownik;break}if(o&&s){u("Nie można przypisać dwóch ratowników na jedną zmianę.","red");return}h[e]=a.id,h[`${e}Name`]=a.name,h[`${e}Ratownik`]=a.ratownik,h[`${e}UserChanged`]=!0;const g={dayShift1:h.dayShift1,dayShift2:h.dayShift2,nightShift1:h.nightShift1,nightShift2:h.nightShift2};this.localData[n.toDateString()]=g,localStorage.setItem(n.toDateString(),JSON.stringify(g)),this.madeChanges=!0,localStorage.removeItem("draggedPerson")},handleClickResetShift(n,e){if(n[e]!==null){n[e]=null,n[e+"Name"]="Usunięto",n[e+"Ratownik"]=null,n[e+"UserChanged"]=!0;const a={dayShift1:n.dayShift1,dayShift2:n.dayShift2,nightShift1:n.nightShift1,nightShift2:n.nightShift2};this.localData[n.date.toDateString()]=a,localStorage.setItem(n.date.toDateString(),JSON.stringify(a)),n[e]="Usunięto",this.madeChanges=!0}},resolvePersonName(n){const e=this.people.find(a=>a.id===n);return e?{name:e.name,isRatownik:e.ratownik}:{name:void 0,isRatownik:!1}},generateMonthDays(){const n=this.selectedYear,e=this.selectedMonth,a=new Date(n,e+1,0).getDate();this.monthDays=[];for(let h=1;h<=a;h++)this.monthDays.push({date:new Date(n,e,h),dayShift1:null,dayShift2:null,nightShift1:null,nightShift2:null,dayShift1Name:"Not assigned",dayShift2Name:"Not assigned",nightShift1Name:"Not assigned",nightShift2Name:"Not assigned",isCurrentMonth:!0});this.loadFromLocalStorage()},changeMonth(n){this.madeChanges&&!confirm("You have unsaved changes. Are you sure you want to switch the month? Your changes will be discarded.")||(this.selectedMonth=this.selectedMonth+n,this.generateMonthDays())},emitEditingMode(n){this.$emit("update-editing-mode",n)},async fetchServerShiftData(){this.syncedChanges={};try{const n=await fetch("https://mc.kot.li/?key=shiftData.json",{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw n.status===404&&u("Data not found on server","red"),new Error(`Failed to fetch data from server: ${n.status}`);return await n.json()}catch(n){return console.error("Error fetching data from server:",n),u("Failed to fetch data from server","red"),null}},async checkShiftDataSync(){this.resetSyncedChangesSessionStorage();const n=await this.fetchServerShiftData();if(!n){console.log("No remote data fetched.");return}const e={};for(const[a,h]of Object.entries(n)){const i=localStorage.getItem(a),o=i?JSON.parse(i):null,s={};if(!o)e[a]={...h},localStorage.setItem(a,JSON.stringify(h));else{for(const[g,f]of Object.entries(h)){const t=o[g]||null;t!==f&&(s[g]={from:t||"Empty",to:f||"Empty"})}Object.keys(s).length>0&&(e[a]=s),localStorage.setItem(a,JSON.stringify(h))}}this.generateMonthDays(),this.syncedChanges=e,console.log("Updated syncedChanges:",this.syncedChanges),sessionStorage.setItem("syncedChanges",JSON.stringify(this.syncedChanges)),setTimeout(()=>{console.log("Clearing syncedChanges."),this.syncedChanges={},sessionStorage.removeItem("syncedChanges")},5e3)},loadFromLocalStorage(){const n=this.selectedYear,e=this.selectedMonth;for(let a=1;a<=31;a++){const h=new Date(n,e,a).toDateString();if(this.syncedChanges[h])continue;const i=localStorage.getItem(h);if(i)try{const o=JSON.parse(i),s=this.monthDays.find(g=>g.date.toDateString()===h);if(s){s.dayShift1=o.dayShift1,s.dayShift2=o.dayShift2,s.nightShift1=o.nightShift1,s.nightShift2=o.nightShift2;const g=this.resolvePersonName(s.dayShift1);s.dayShift1Name=g.name,s.dayShift1Ratownik=g.isRatownik;const f=this.resolvePersonName(s.dayShift2);s.dayShift2Name=f.name,s.dayShift2Ratownik=f.isRatownik;const t=this.resolvePersonName(s.nightShift1);s.nightShift1Name=t.name,s.nightShift1Ratownik=t.isRatownik;const w=this.resolvePersonName(s.nightShift2);s.nightShift2Name=w.name,s.nightShift2Ratownik=w.isRatownik}}catch(o){u("Failed to load local data: "+o,"red")}}},resetSyncedChangesSessionStorage(){const n=sessionStorage.getItem("syncedChanges");n&&(this.syncedChanges=JSON.parse(n),setTimeout(()=>{this.syncedChanges={},sessionStorage.removeItem("syncedChanges")},5e3))},resetUserChanges(){for(const n in localStorage)if(localStorage.hasOwnProperty(n)){const e=JSON.parse(localStorage.getItem(n)||"{}");(e.dayShift1UserChanged||e.dayShift2UserChanged||e.nightShift1UserChanged||e.nightShift2UserChanged)&&localStorage.removeItem(n)}this.localData={},this.madeChanges=!1},handleScroll(n){this.scrollContainer&&(n.preventDefault(),this.scrollContainer.scrollLeft+=n.deltaY)},getDayClass(n){return y[n]==="Nd"?"nd-color":y[n]==="Sob"?"sob-color":"normal-color"},showPasswordPrompt(){this.showPasswordModal=!0}},async mounted(){this.resetUserChanges(),await this.checkShiftDataSync(),this.scrollContainer=this.$refs.scrollContainer},watch:{isEditingMode(n){localStorage.setItem("isEditingMode",JSON.stringify(n))}}},O=["disabled"],x={class:"monthChange"},z={style:{"font-weight":"bold",width:"200px !important"}},U={class:"top-right-buttons compact-toggle"},I=["checked"],J={class:"slider"},L={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"pencil-icon"},T={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"pencil-icon"},W={class:"calendar-container"},j={class:"calendar-grid"},A=["onDrop"],Y={class:"day-header"},F=["onDrop"],B={class:"day-date"},V=["clickable","onDrop","onClick","onTouchend"],q={key:0,class:"assigned-person"},G={key:1,class:"empty-slot"},Z=["clickable","onDrop","onClick","onTouchend"],H={key:0,class:"assigned-person"},K={key:1,class:"empty-slot"},Q=["clickable","onDrop","onClick","onTouchend"],X={key:0,class:"assigned-person"},$={key:1,class:"empty-slot"},ee=["clickable","onDrop","onClick","onTouchend"],te={key:0,class:"assigned-person"},ne={key:1,class:"empty-slot"},oe={key:0,style:{display:"flex","flex-direction":"column","align-items":"center"}};function ae(n,e,a,h,i,o){const s=p("AuthorizationModal"),g=p("PeopleListWindow"),f=p("ShiftCountWindow");return l(),d(C,null,[D(s,{show:i.showPasswordModal,localData:i.localData,onClose:e[0]||(e[0]=t=>i.showPasswordModal=!1),onAuthorized:n.handleAuthorization},null,8,["show","localData","onAuthorized"]),r("button",{disabled:!i.madeChanges,onClick:e[1]||(e[1]=(...t)=>o.showPasswordPrompt&&o.showPasswordPrompt(...t)),class:"submit-button"}," Zapisz ",8,O),r("section",null,[r("section",x,[r("button",{class:"buttonMonthChange",onClick:e[2]||(e[2]=t=>o.changeMonth(-1))}," ‹ "),r("span",z,S(o.monthYear.toUpperCase()),1),r("button",{class:"buttonMonthChange",onClick:e[3]||(e[3]=t=>o.changeMonth(1))},"›")]),r("button",{class:"top-right-buttons buttonRefresh",onClick:e[4]||(e[4]=t=>o.checkShiftDataSync())},e[12]||(e[12]=[r("img",{src:"/assets/icons/refresh.svg",style:{width:"30px",height:"30px",cursor:"pointer"},alt:"Refresh"},null,-1)])),r("label",U,[r("input",{type:"checkbox",checked:a.isEditingMode,onChange:e[5]||(e[5]=t=>o.emitEditingMode(t.target.checked))},null,40,I),r("span",J,[a.isEditingMode?(l(),d("svg",T,e[14]||(e[14]=[r("path",{d:"M12 20h9"},null,-1),r("path",{d:"M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"},null,-1)]))):(l(),d("svg",L,e[13]||(e[13]=[r("path",{d:"M12 20h9"},null,-1),r("path",{d:"M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"},null,-1)])))])])]),r("div",W,[r("section",{class:"scrollable-container",onWheel:e[11]||(e[11]=m((...t)=>o.handleScroll&&o.handleScroll(...t),["prevent"])),ref:"scrollContainer"},[r("div",j,[(l(!0),d(C,null,_(i.monthDays,(t,w)=>(l(),d("div",{key:w,class:"day-column",onDragover:e[10]||(e[10]=m(()=>{},["prevent"])),onDrop:c=>o.handleDrop(t.date,"day")},[r("div",null,[r("div",{class:k(["day-cell",{"current-month":t.isCurrentMonth,"nd-color":i.daysOfWeek[t.date.getDay()]==="Nd","sob-color":i.daysOfWeek[t.date.getDay()]==="Sob"}])},[r("div",Y,S(i.daysOfWeek[t.date.getDay()]),1),r("div",{class:"shift",onDrop:c=>o.handleDrop(t.date,"day"),onDragover:e[9]||(e[9]=m(()=>{},["prevent"]))},[r("div",B,S(t.date.getDate()),1),r("div",{class:k(["shift-slot day",{"synced-changed":i.syncedChanges[t.date.toDateString()]?.dayShift1,ratownik:t.dayShift1Ratownik===!0,pielegniarka:t.dayShift1Ratownik===!1,userChanged:t.dayShift1UserChanged===!0}]),clickable:a.isEditingMode,onDragover:e[6]||(e[6]=m(()=>{},["prevent"])),onDrop:c=>o.handleDrop(t.date,"dayShift1"),onClick:c=>o.handleClickResetShift(t,"dayShift1"),onTouchend:c=>o.handleDrop(t.date,"dayShift1")},[t.dayShift1?(l(),d("div",q,S(t.dayShift1Name),1)):(l(),d("div",G,"D"))],42,V),r("div",{class:k(["shift-slot day",{"synced-changed":i.syncedChanges[t.date.toDateString()]?.dayShift2,ratownik:t.dayShift2Ratownik===!0,pielegniarka:t.dayShift2Ratownik===!1,userChanged:t.dayShift2UserChanged===!0}]),clickable:a.isEditingMode,onDrop:c=>o.handleDrop(t.date,"dayShift2"),onClick:c=>o.handleClickResetShift(t,"dayShift2"),onTouchend:c=>o.handleDrop(t.date,"dayShift2")},[t.dayShift2?(l(),d("div",H,S(t.dayShift2Name),1)):(l(),d("div",K,"D"))],42,Z),r("div",{class:k(["shift-slot night",{"synced-changed":i.syncedChanges[t.date.toDateString()]?.nightShift1,ratownik:t.nightShift1Ratownik===!0,pielegniarka:t.nightShift1Ratownik===!1,userChanged:t.nightShift1UserChanged===!0}]),clickable:a.isEditingMode,onDragover:e[7]||(e[7]=m(()=>{},["prevent"])),onDrop:c=>o.handleDrop(t.date,"nightShift1"),onClick:c=>o.handleClickResetShift(t,"nightShift1"),onTouchend:c=>o.handleDrop(t.date,"nightShift1")},[t.nightShift1?(l(),d("div",X,S(t.nightShift1Name),1)):(l(),d("div",$,"N"))],42,Q),r("div",{class:k(["shift-slot night",{"synced-changed":i.syncedChanges[t.date.toDateString()]?.nightShift2,ratownik:t.nightShift2Ratownik===!0,pielegniarka:t.nightShift2Ratownik===!1,userChanged:t.nightShift2UserChanged===!0}]),clickable:a.isEditingMode,onDragover:e[8]||(e[8]=m(()=>{},["prevent"])),onDrop:c=>o.handleDrop(t.date,"nightShift2"),onClick:c=>o.handleClickResetShift(t,"nightShift2"),onTouchend:c=>o.handleDrop(t.date,"nightShift2")},[t.nightShift2?(l(),d("div",te,S(t.nightShift2Name),1)):(l(),d("div",ne,"N"))],42,ee)],40,F)],2)])],40,A))),128))])],544)]),D(g,{people:i.people,isEditingMode:a.isEditingMode},null,8,["people","isEditingMode"]),a.isEditingMode?(l(),d("div",oe,e[15]||(e[15]=[r("h1",{style:{background:"var(--glass-bg-color)","backdrop-filter":"blur(var(--glass-blur))","-webkit-backdrop-filter":"blur(var(--glass-blur))",border:"1px solid var(--glass-border-color)","border-radius":"var(--border-radius-small)",filter:"drop-shadow(var(--shadow-drop))",color:"var(--color-text-dark)","font-size":"20px","box-shadow":"var(--glass-box-shadow)",padding:"var(--spacing-medium)"}},[R(" Tryb edytowania "),r("a",{style:{color:"green"}},"Włączony")],-1)]))):P("",!0),D(f,{people:i.people,monthDays:i.monthDays},null,8,["people","monthDays"])],64)}const he=N(E,[["render",ae],["__scopeId","data-v-01133e7c"]]);export{he as default};
