import{d as p,c as v}from"./index-BjQfNs8I.js";import{addNotification as f}from"./NotificationMessage-TpBAZ_v7.js";import{_ as C,o as l,c as h,a as n,w as b,v as N,b as M,t as g,d as S,F as u,r as y,e as w,n as k}from"./index-DWJvP2_r.js";const P={name:"CalendarComponent",data(){return{selectedMonth:new Date().getMonth(),selectedYear:new Date().getFullYear(),monthDays:[],localData:{},changedShifts:{},syncedChanges:{},daysOfWeek:p,currentDate:new Date,draggedPerson:null,people:[{id:1,name:"Milena",ratownik:!1},{id:2,name:"Mikołaj",ratownik:!1},{id:3,name:"Aleksandra",ratownik:!1},{id:4,name:"Łukasz",ratownik:!0},{id:5,name:"Joanna",ratownik:!0},{id:6,name:"Natalia",ratownik:!0},{id:7,name:"Marcin",ratownik:!0},{id:8,name:"Alina",ratownik:!1},{id:9,name:"Ewelina",ratownik:!1},{id:7,name:"Teresa",ratownik:!1}],madeChanges:!1,showPasswordModal:!1,password:"",locale:"pl",scrollContainer:null,isEditingMode:JSON.parse(localStorage.getItem("isEditingMode"))||!1}},computed:{monthYear(){return new Date(this.selectedYear,this.selectedMonth).toLocaleString(this.locale,{month:"long",year:"numeric"})}},methods:{startDrag(s){this.draggedPerson=s},handleDrop(s,e){if(!this.draggedPerson)return;const i=this.monthDays.find(c=>c.date.toDateString()===s.toDateString());i[e];const o={...i,[e]:this.draggedPerson.id};if(o.dayShift1!=null&&o.dayShift2!=null&&o.dayShift1===o.dayShift2||o.nightShift1!=null&&o.nightShift2!=null&&o.nightShift1===o.nightShift2){f("Ta sama osoba na obydwu zmianach.","red");return}const r=this.draggedPerson.ratownik;let a=!1;switch(e){case"dayShift1":a=i.dayShift2Ratownik;break;case"dayShift2":a=i.dayShift1Ratownik;break;case"nightShift1":a=i.nightShift2Ratownik;break;case"nightShift2":a=i.nightShift1Ratownik;break}if(r&&a){f("Nie można przypisać dwóch ratowników na jedną zmianę.","red");return}i[e]=this.draggedPerson.id,i[`${e}Name`]=this.draggedPerson.name,i[`${e}Ratownik`]=this.draggedPerson.ratownik,i[`${e}UserChanged`]=!0;const t={dayShift1:i.dayShift1,dayShift2:i.dayShift2,nightShift1:i.nightShift1,nightShift2:i.nightShift2};this.localData[s.toDateString()]=t,localStorage.setItem(s.toDateString(),JSON.stringify(t)),this.madeChanges=!0,this.draggedPerson=null},handleClickResetShift(s,e){if(s[e]!==null){s[e]=null,s[e+"Name"]="Usunięto",s[e+"Ratownik"]=null,s[e+"UserChanged"]=!0;const i={dayShift1:s.dayShift1,dayShift2:s.dayShift2,nightShift1:s.nightShift1,nightShift2:s.nightShift2};this.localData[s.date.toDateString()]=i,localStorage.setItem(s.date.toDateString(),JSON.stringify(i)),s[e]="Usunięto",this.madeChanges=!0}},resolvePersonName(s){const e=this.people.find(i=>i.id===s);return e?{name:e.name,isRatownik:e.ratownik}:{name:void 0,isRatownik:!1}},generateMonthDays(){const s=this.selectedYear,e=this.selectedMonth,i=new Date(s,e+1,0).getDate();this.monthDays=[];for(let o=1;o<=i;o++)this.monthDays.push({date:new Date(s,e,o),dayShift1:null,dayShift2:null,nightShift1:null,nightShift2:null,dayShift1Name:"Not assigned",dayShift2Name:"Not assigned",nightShift1Name:"Not assigned",nightShift2Name:"Not assigned",isCurrentMonth:!0});this.loadFromLocalStorage()},changeMonth(s){if(this.madeChanges){if(!confirm("You have unsaved changes. Are you sure you want to switch the month? Your changes will be discarded."))return;this.changedShifts={}}this.selectedMonth=this.selectedMonth+s,this.generateMonthDays()},showPasswordPrompt(){this.showPasswordModal=!0},async authorize(){if(v.MD5(this.password).toString()==="71d114fc94f6a0badc14cf88cb4b8d98"){const i=btoa(JSON.stringify(this.localData));try{if(!(await fetch("/api/?key=shiftData.json",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:"shiftData",value:i})})).ok)throw new Error("Failed to update data on the server");this.madeChanges=!1}catch(o){console.error("Error updating server data:",o),f(o.message||"Failed to update data on the server","red")}}else f("Złe hasło","red");this.showPasswordModal=!1,this.password="",this.changedShifts={},f("Zmiany zapisano :3 !","green")},async fetchServerShiftData(){this.syncedChanges={};try{const s=await fetch("/api/?key=shiftData.json",{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw s.status===404&&f("Data not found on server","red"),new Error(`Failed to fetch data from server: ${s.status}`);return await s.json()}catch(s){return console.error("Error fetching data from server:",s),f("Failed to fetch data from server","red"),null}},async checkShiftDataSync(){this.resetSyncedChangesSessionStorage();const s=await this.fetchServerShiftData();if(!s){console.log("No remote data fetched.");return}const e={};for(const[i,o]of Object.entries(s)){const r=localStorage.getItem(i),a=r?JSON.parse(r):null,t={};if(!a)e[i]={...o},localStorage.setItem(i,JSON.stringify(o));else{for(const[c,d]of Object.entries(o)){const m=a[c]||null;m!==d&&(t[c]={from:m||"Empty",to:d||"Empty"})}Object.keys(t).length>0&&(e[i]=t),localStorage.setItem(i,JSON.stringify(o))}}this.generateMonthDays(),this.syncedChanges=e,console.log("Updated syncedChanges:",this.syncedChanges),sessionStorage.setItem("syncedChanges",JSON.stringify(this.syncedChanges)),setTimeout(()=>{console.log("Clearing syncedChanges."),this.syncedChanges={},sessionStorage.removeItem("syncedChanges")},5e3)},async encodeLargeData(s){try{localStorage.removeItem("isEditingMode");const e=JSON.stringify(s,null,2),i=new Blob([e],{type:"application/json"}),o=new FileReader,r=await new Promise((a,t)=>{o.onloadend=()=>{a(o.result.split(",")[1])},o.onerror=()=>t(new Error("Failed to read the Blob")),o.readAsDataURL(i)});return localStorage.setItem("isEditingMode",JSON.stringify(!0)),r}catch(e){return console.error("Error encoding large data:",e),this.addNotification("Error encoding data","red"),localStorage.setItem("isEditingMode",JSON.stringify(!0)),null}},cancel(){this.showPasswordModal=!1,this.password=""},loadFromLocalStorage(){const s=this.selectedYear,e=this.selectedMonth;for(let i=1;i<=31;i++){const o=new Date(s,e,i).toDateString();if(this.syncedChanges[o])continue;const r=localStorage.getItem(o);if(r)try{const a=JSON.parse(r),t=this.monthDays.find(c=>c.date.toDateString()===o);if(t){t.dayShift1=a.dayShift1,t.dayShift2=a.dayShift2,t.nightShift1=a.nightShift1,t.nightShift2=a.nightShift2;const c=this.resolvePersonName(t.dayShift1);t.dayShift1Name=c.name,t.dayShift1Ratownik=c.isRatownik;const d=this.resolvePersonName(t.dayShift2);t.dayShift2Name=d.name,t.dayShift2Ratownik=d.isRatownik;const m=this.resolvePersonName(t.nightShift1);t.nightShift1Name=m.name,t.nightShift1Ratownik=m.isRatownik;const D=this.resolvePersonName(t.nightShift2);t.nightShift2Name=D.name,t.nightShift2Ratownik=D.isRatownik}}catch(a){f("Failed to load local data: "+a,"red")}}this.calculateAllShiftCounts()},resetSyncedChangesSessionStorage(){const s=sessionStorage.getItem("syncedChanges");s&&(this.syncedChanges=JSON.parse(s),setTimeout(()=>{this.syncedChanges={},sessionStorage.removeItem("syncedChanges")},5e3))},handleScroll(s){this.scrollContainer&&(s.preventDefault(),this.scrollContainer.scrollLeft+=s.deltaY)},getDayClass(s){return p[s]==="Nd"?"nd-color":p[s]==="Sob"?"sob-color":"normal-color"},countShiftsForPerson(s){return this.monthDays.reduce((e,i)=>i.dayShift1===s||i.dayShift2===s||i.nightShift1===s||i.nightShift2===s?e+1:e,0)},calculateAllShiftCounts(){this.people.forEach(s=>{s.shiftCount=this.countShiftsForPerson(s.id)})}},async mounted(){await this.checkShiftDataSync(),this.scrollContainer=this.$refs.scrollContainer},watch:{isEditingMode(s){localStorage.setItem("isEditingMode",JSON.stringify(s))}}},R=["disabled"],_={key:0,class:"modal"},O={class:"modal-content"},E={class:"monthChange"},x={style:{"font-weight":"bold"}},z={class:"calendar-container"},J={class:"calendar-grid"},F=["onDrop"],j={class:"day-header"},I=["onDrop"],U={class:"day-date"},Y=["onDrop","onClick"],A={key:0,class:"assigned-person"},L={key:1,class:"empty-slot"},W=["onDrop","onClick"],T={key:0,class:"assigned-person"},V={key:1,class:"empty-slot"},B=["onDrop","onClick"],Z={key:0,class:"assigned-person"},H={key:1,class:"empty-slot"},G=["onDrop","onClick"],q={key:0,class:"assigned-person"},K={key:1,class:"empty-slot"},Q={class:"people-list"},X={class:"person-lists"},$=["onDragstart"],tt={class:"person-lists"},et=["onDragstart"],st={class:"shift-counts-window"},nt={style:{display:"flex","flex-direction":"row"}},at={style:{display:"flex","flex-direction":"column"}},it={class:"shift-counts"},ot={style:{display:"flex","flex-direction":"column"}},rt={class:"shift-counts"};function lt(s,e,i,o,r,a){return l(),h(u,null,[n("button",{disabled:!r.madeChanges,onClick:e[0]||(e[0]=(...t)=>a.showPasswordPrompt&&a.showPasswordPrompt(...t)),class:"submit-button"}," Zapisz ",8,R),r.showPasswordModal?(l(),h("section",_,[n("div",O,[e[14]||(e[14]=n("p",null,"Wpisz hasło:",-1)),b(n("input",{type:"password","onUpdate:modelValue":e[1]||(e[1]=t=>r.password=t)},null,512),[[N,r.password]]),n("button",{onClick:e[2]||(e[2]=(...t)=>a.authorize&&a.authorize(...t))},"Zapisz"),n("button",{onClick:e[3]||(e[3]=(...t)=>a.cancel&&a.cancel(...t))},"Anuluj")])])):M("",!0),n("section",null,[n("section",E,[n("button",{class:"buttonMonthChange",onClick:e[4]||(e[4]=t=>a.changeMonth(-1))}," ‹ "),n("span",x,g(a.monthYear.toUpperCase()),1),n("button",{class:"buttonMonthChange",onClick:e[5]||(e[5]=t=>a.changeMonth(1))},"›")]),n("button",{class:"top-right-buttons buttonRefresh",onClick:e[6]||(e[6]=t=>a.checkShiftDataSync())},e[15]||(e[15]=[n("img",{src:"/assets/icons/refresh.svg",style:{width:"30px",height:"30px",cursor:"pointer"},alt:"Refresh"},null,-1)])),n("button",{class:"top-right-buttons buttonFilter",onClick:e[7]||(e[7]=t=>s.filterCalendar())},e[16]||(e[16]=[n("img",{src:"/assets/icons/filter.svg",style:{width:"30px",height:"30px",cursor:"pointer"},alt:"Refresh"},null,-1)]))]),n("div",z,[n("section",{class:"scrollable-container",onWheel:e[13]||(e[13]=S((...t)=>a.handleScroll&&a.handleScroll(...t),["prevent"])),ref:"scrollContainer"},[n("div",J,[(l(!0),h(u,null,y(r.monthDays,(t,c)=>(l(),h("div",{key:c,class:"day-column",onDragover:e[12]||(e[12]=S(()=>{},["prevent"])),onDrop:d=>a.handleDrop(t.date,"day")},[n("div",null,[n("div",{class:k(["day-cell",{"current-month":t.isCurrentMonth,"nd-color":r.daysOfWeek[t.date.getDay()]==="Nd","sob-color":r.daysOfWeek[t.date.getDay()]==="Sob"}])},[n("div",j,g(r.daysOfWeek[t.date.getDay()]),1),n("div",{class:"shift",onDrop:d=>a.handleDrop(t.date,"day"),onDragover:e[11]||(e[11]=S(()=>{},["prevent"]))},[n("div",U,g(t.date.getDate()),1),n("div",{class:k(["shift-slot day",{"synced-changed":r.syncedChanges[t.date.toDateString()]?.dayShift1,ratownik:t.dayShift1Ratownik===!0,userChanged:t.dayShift1UserChanged===!0}]),onDragover:e[8]||(e[8]=S(()=>{},["prevent"])),onDrop:d=>a.handleDrop(t.date,"dayShift1"),onClick:d=>a.handleClickResetShift(t,"dayShift1")},[t.dayShift1?(l(),h("div",A,g(t.dayShift1Name),1)):(l(),h("div",L,"D"))],42,Y),n("div",{class:k(["shift-slot day",{"synced-changed":r.syncedChanges[t.date.toDateString()]?.dayShift2,ratownik:t.dayShift2Ratownik===!0,userChanged:t.dayShift2UserChanged===!0}]),onDrop:d=>a.handleDrop(t.date,"dayShift2"),onClick:d=>a.handleClickResetShift(t,"dayShift2")},[t.dayShift2?(l(),h("div",T,g(t.dayShift2Name),1)):(l(),h("div",V,"D"))],42,W),n("div",{class:k(["shift-slot night",{"synced-changed":r.syncedChanges[t.date.toDateString()]?.nightShift1,ratownik:t.nightShift1Ratownik===!0,userChanged:t.nightShift1UserChanged===!0}]),onDragover:e[9]||(e[9]=S(()=>{},["prevent"])),onDrop:d=>a.handleDrop(t.date,"nightShift1"),onClick:d=>a.handleClickResetShift(t,"nightShift1")},[t.nightShift1?(l(),h("div",Z,g(t.nightShift1Name),1)):(l(),h("div",H,"N"))],42,B),n("div",{class:k(["shift-slot night",{"synced-changed":r.syncedChanges[t.date.toDateString()]?.nightShift2,ratownik:t.nightShift2Ratownik===!0,userChanged:t.nightShift2UserChanged===!0}]),onDragover:e[10]||(e[10]=S(()=>{},["prevent"])),onDrop:d=>a.handleDrop(t.date,"nightShift2"),onClick:d=>a.handleClickResetShift(t,"nightShift2")},[t.nightShift2?(l(),h("div",q,g(t.nightShift2Name),1)):(l(),h("div",K,"N"))],42,G)],40,I)],2)])],40,F))),128))])],544)]),n("section",Q,[e[19]||(e[19]=n("h3",{style:{"font-weight":"bold"}},"Zespół",-1)),n("div",null,[e[17]||(e[17]=n("h4",null,"Ratowniczki/cy",-1)),n("div",X,[(l(!0),h(u,null,y(r.people.filter(t=>t.ratownik),t=>(l(),h("div",{key:t.id,class:"person-item ratownik",draggable:"true",onDragstart:c=>a.startDrag(t)},g(t.name),41,$))),128))]),e[18]||(e[18]=n("h4",null,"Pielęgniarki/rze",-1)),n("div",tt,[(l(!0),h(u,null,y(r.people.filter(t=>!t.ratownik),t=>(l(),h("div",{key:t.id,class:"person-item",draggable:"true",onDragstart:c=>a.startDrag(t)},g(t.name),41,et))),128))])])]),e[25]||(e[25]=n("div",{style:{display:"flex","flex-direction":"column","align-items":"center"}},[n("h1",{style:{background:"var(--glass-bg-color)","backdrop-filter":"blur(var(--glass-blur))","-webkit-backdrop-filter":"blur(var(--glass-blur))",border:"1px solid var(--glass-border-color)","border-radius":"var(--border-radius-small)",filter:"drop-shadow(var(--shadow-drop))","box-shadow":"var(--glass-box-shadow)",width:"600px",padding:"var(--spacing-medium)"}},[w(" Tryb edytowania "),n("a",{style:{color:"green"}},"Włączony")])],-1)),n("section",st,[e[24]||(e[24]=n("h3",null,"Ilość zmian",-1)),n("div",nt,[n("div",at,[e[21]||(e[21]=n("h4",null,"Ratowniczki/cy",-1)),n("ul",it,[(l(!0),h(u,null,y(r.people.filter(t=>t.ratownik),t=>(l(),h("li",{key:t.id},[w(g(t.name)+": ",1),n("strong",null,g(t.shiftCount||0),1),e[20]||(e[20]=w(" zmian/a "))]))),128))])]),n("div",ot,[e[23]||(e[23]=n("h4",null,"Pielęgniarki/rze",-1)),n("ul",rt,[(l(!0),h(u,null,y(r.people.filter(t=>!t.ratownik),t=>(l(),h("li",null,[w(g(t.name)+": ",1),n("strong",null,g(t.shiftCount||0),1),e[22]||(e[22]=w(" zmian/a "))]))),256))])])])])],64)}const gt=C(P,[["render",lt],["__scopeId","data-v-9373ed5e"]]);export{gt as default};
