import{d as M}from"./daysOfWeek-C19XqJ9X.js";import{N as v,r as p,c as U,a as c,_ as b}from"./utils-BjyM4F9V.js";import{c as f,o as g,d as o,F as m,a as u,q as O,n as D,t as N,w as z,s as P}from"./vue-vendor-RtJloCyB.js";const _={name:"SpreadsheetView",emits:["update-editing-mode","has-changes","month-days-updated"],props:{isEditingMode:{type:Boolean,required:!0},selectedMonth:{type:Number,required:!0},selectedYear:{type:Number,required:!0},people:{type:Array,required:!0}},components:{NotificationMessage:v},data(){return{editedShifts:{},monthDays:[],localData:{},daysOfWeek:M,madeChanges:!1,scrollContainer:null}},computed:{daysInMonth(){return this.monthDays.map(e=>e.date.getDate())},orderedPeople(){const e=["Milena","Mikołaj","Aleksandra","Joanna","Łukasz","Natalia","Marcin"];return this.people.filter(i=>e.includes(i.name)).sort((i,a)=>e.indexOf(i.name)-e.indexOf(a.name))}},watch:{selectedMonth(){this.generateMonthDays()},selectedYear(){this.generateMonthDays()}},methods:{isEditing(e,i){return this.editedShifts.hasOwnProperty(`${e}-${i}`)},getShiftForPersonAndDay(e,i){const a=this.monthDays.find(s=>s.date.getDate()===i)?.date.toDateString(),d=localStorage.getItem(a);if(d){const s=JSON.parse(d),h=[];return(s.dayShift1===e||s.dayShift2===e)&&h.push("D"),(s.nightShift1===e||s.nightShift2===e)&&h.push("N"),h.join(" ")}return null},editCell(e,i){if(this.isEditingMode){const a=`${e}-${i}`,d=this.getShiftForPersonAndDay(e,i)||"";this.editedShifts[a]=d}},saveShift(e,i){const a=`${e}-${i}`,d=this.editedShifts[a]?.trim().toUpperCase()||"",s=this.getShiftForPersonAndDay(e,i)||"";if(!["D","N","D N",""].includes(d)){c("Zła wartość! Tylko 'D', 'N', lub 'D N' są dozwolone.","red"),this.$nextTick(()=>{this.editedShifts[a]=s});return}const n=this.monthDays.find(l=>l.date.getDate()===i)?.date.toDateString();if(!n||!this.monthDays)return;const t=this.monthDays.find(l=>l.date.toDateString()===n);if(!t)return;if(t.dayShift1===e&&(t.dayShift1=null,t.dayShift1Name="Not assigned",t.dayShift1UserChanged=!0),t.dayShift2===e&&(t.dayShift2=null,t.dayShift2Name="Not assigned",t.dayShift2UserChanged=!0),t.nightShift1===e&&(t.nightShift1=null,t.nightShift1Name="Not assigned",t.nightShift1UserChanged=!0),t.nightShift2===e&&(t.nightShift2=null,t.nightShift2Name="Not assigned",t.nightShift2UserChanged=!0),d===""){const l={dayShift1:t.dayShift1,dayShift2:t.dayShift2,nightShift1:t.nightShift1,nightShift2:t.nightShift2,dayShift1Name:t.dayShift1Name,dayShift2Name:t.dayShift2Name,nightShift1Name:t.nightShift1Name,nightShift2Name:t.nightShift2Name};this.localData[n]=l,localStorage.setItem(n,JSON.stringify(l)),this.madeChanges=!0,this.$emit("has-changes",this.madeChanges),this.$nextTick(()=>{delete this.editedShifts[a],this.$forceUpdate()});return}const r=this.people.find(l=>l.id===e);if(d.includes("D")){if(r?.ratownik&&[t.dayShift1,t.dayShift2].filter(Boolean).some(S=>this.people.find(y=>y.id===S)?.ratownik&&S!==e)){c("Nie można przypisać dwóch ratowników na zmianę dzienną.","red"),delete this.editedShifts[a];return}if(!t.dayShift1)t.dayShift1=e,t.dayShift1Name=r.name,t.dayShift1UserChanged=!0;else if(!t.dayShift2)t.dayShift2=e,t.dayShift2Name=r.name,t.dayShift2UserChanged=!0;else{c("Nie można przypisać więcej niż dwóch osób na zmianę dzienną.","red"),delete this.editedShifts[a];return}}if(d.includes("N")){if(r?.ratownik&&[t.nightShift1,t.nightShift2].filter(Boolean).some(S=>this.people.find(y=>y.id===S)?.ratownik&&S!==e)){c("Nie można przypisać dwóch ratowników na zmianę nocną.","red"),delete this.editedShifts[a];return}if(!t.nightShift1)t.nightShift1=e,t.nightShift1Name=r.name,t.nightShift1UserChanged=!0;else if(!t.nightShift2)t.nightShift2=e,t.nightShift2Name=r.name,t.nightShift2UserChanged=!0;else{c("Nie można przypisać więcej niż dwóch osób na zmianę nocną.","red"),delete this.editedShifts[a];return}}const w={dayShift1:t.dayShift1,dayShift2:t.dayShift2,nightShift1:t.nightShift1,nightShift2:t.nightShift2};this.localData[n]=w,this.madeChanges=!0,this.$emit("has-changes",this.madeChanges),localStorage.setItem(n,JSON.stringify(w)),delete this.editedShifts[a]},generateMonthDays(){this.resetUserChanges();const e=this.selectedYear,i=this.selectedMonth,a=new Date(e,i+1,0).getDate();this.monthDays=[];for(let d=1;d<=a;d++)this.monthDays.push({date:new Date(e,i,d),dayShift1:null,dayShift2:null,nightShift1:null,nightShift2:null,dayShift1Name:"Not assigned",dayShift2Name:"Not assigned",nightShift1Name:"Not assigned",nightShift2Name:"Not assigned",isCurrentMonth:!0});this.loadFromLocalStorage(),this.$emit("month-days-updated",this.monthDays)},updateChanges(e){this.madeChanges=e,this.$emit("has-changes",this.madeChanges)},loadFromLocalStorage(){const e=this.selectedYear,i=this.selectedMonth;for(let a=1;a<=31;a++){const d=new Date(e,i,a).toDateString(),s=localStorage.getItem(d);if(s)try{const h=JSON.parse(s),n=this.monthDays.find(t=>t.date.toDateString()===d);n&&(n.dayShift1=h.dayShift1,n.dayShift2=h.dayShift2,n.nightShift1=h.nightShift1,n.nightShift2=h.nightShift2,n.dayShift1Name=h.dayShift1Name||"Not assigned",n.dayShift2Name=h.dayShift2Name||"Not assigned",n.nightShift1Name=h.nightShift1Name||"Not assigned",n.nightShift2Name=h.nightShift2Name||"Not assigned")}catch{c("Nie udało się załadować danych lokalnych. Sprawdź konsolę.","red")}}},resolvePersonName(e){const i=this.people.find(a=>a.id===e);return i?{name:i.name,isRatownik:i.ratownik}:{name:void 0,isRatownik:!1}},async checkShiftDataSync(){this.syncedChanges=await U(()=>this.generateMonthDays())},resetSyncedChangesSessionStorage(){this.syncedChanges=p()},handleScroll(e){this.scrollContainer&&(e.preventDefault(),this.scrollContainer.scrollLeft+=e.deltaY)},resetUserChanges(){for(const e in localStorage)if(!(e==="isEditingMode"||e==="currentPage")&&localStorage.hasOwnProperty(e))try{const i=JSON.parse(localStorage.getItem(e)||"{}");(i.dayShift1UserChanged||i.dayShift2UserChanged||i.nightShift1UserChanged||i.nightShift2UserChanged)&&localStorage.removeItem(e)}catch{continue}this.localData={},this.madeChanges=!1,this.$emit("has-changes",this.madeChanges),this.editedShifts={}},isToday(e){const i=new Date;return e.getDate()===i.getDate()&&e.getMonth()===i.getMonth()&&e.getFullYear()===i.getFullYear()}},mounted(){this.resetUserChanges(),this.generateMonthDays(),this.scrollContainer=this.$refs.scrollContainer}},Y={class:"spreadsheet-view"},E={class:"calendar-table"},F=["onClick","aria-label","title"],V={key:0},x=["onUpdate:modelValue","onChange"];function j(e,i,a,d,s,h){return g(),f("div",Y,[o("div",{class:"scrollable-container",onWheel:i[0]||(i[0]=O((...n)=>h.handleScroll&&h.handleScroll(...n),["prevent"])),ref:"scrollContainer"},[o("table",E,[o("thead",null,[o("tr",null,[i[1]||(i[1]=o("th",null,null,-1)),(g(!0),f(m,null,u(h.daysInMonth,n=>(g(),f("th",{key:n,class:D({"nd-color":s.daysOfWeek[new Date(a.selectedYear,a.selectedMonth,n).getDay()]==="Nd","sob-color":s.daysOfWeek[new Date(a.selectedYear,a.selectedMonth,n).getDay()]==="Sob","today-column":h.isToday(new Date(a.selectedYear,a.selectedMonth,n))})},N(n),3))),128))])]),o("tbody",null,[(g(!0),f(m,null,u(h.orderedPeople,n=>(g(),f("tr",{key:n.id},[o("td",{class:D({ratownik:n.ratownik,pielegniarka:!n.ratownik})},N(n.name),3),(g(!0),f(m,null,u(h.daysInMonth,t=>(g(),f("td",{key:t,class:D(["editable-cell",{"nd-color":s.daysOfWeek[new Date(a.selectedYear,a.selectedMonth,t).getDay()]==="Nd","sob-color":s.daysOfWeek[new Date(a.selectedYear,a.selectedMonth,t).getDay()]==="Sob",today:h.isToday(new Date(a.selectedYear,a.selectedMonth,t))}]),onClick:r=>h.editCell(n.id,t),"aria-label":a.isEditingMode?"Kliknij aby edytować zmianę":"",title:a.isEditingMode?"Kliknij aby edytować zmianę":"",role:"gridcell"},[!a.isEditingMode||!h.isEditing(n.id,t)?(g(),f("span",V,N(h.getShiftForPersonAndDay(n.id,t)||""),1)):z((g(),f("select",{key:1,"onUpdate:modelValue":r=>s.editedShifts[`${n.id}-${t}`]=r,onChange:r=>h.saveShift(n.id,t)},i[2]||(i[2]=[o("option",{value:""},null,-1),o("option",{value:"D"},"D",-1),o("option",{value:"N"},"N",-1),o("option",{value:"D N"},"D N",-1)]),40,x)),[[P,s.editedShifts[`${n.id}-${t}`]]])],10,F))),128))]))),128))])])],544)])}const R=b(_,[["render",j],["__scopeId","data-v-31dd0ca0"]]);export{R as default};
