import{d as k}from"./daysOfWeek-C19XqJ9X.js";import{_ as v,a as m,o as g,c,b as h,d as p,w as l,F as D,r as C,n as u,t as f}from"./index-BdhuNycK.js";import b from"./ShiftCountWindow-By2PpPOj.js";import w from"./PeopleListWindow-CdK7Wm6D.js";const N={name:"CalendarComponent",emits:["update-editing-mode","has-changes","month-days-updated"],components:{ShiftCountWindow:b,PeopleListWindow:w},props:{isEditingMode:{type:Boolean,required:!0},selectedMonth:{type:Number,required:!0},selectedYear:{type:Number,required:!0},people:{type:Array,required:!0}},data(){return{monthDays:[],localData:{},syncedChanges:{},daysOfWeek:k,currentDate:new Date,madeChanges:!1,scrollContainer:null,currentDropTarget:{date:null,shiftType:null},showMobileWarning:!1,isMobileDevice:!1}},methods:{handleDrop(t,i){const n=JSON.parse(localStorage.getItem("draggedPerson"));if(!n)return;const o=this.monthDays.find(s=>s.date.toDateString()===t.toDateString()),r={...o,[i]:n.id};if(r.dayShift1!=null&&r.dayShift2!=null&&r.dayShift1===r.dayShift2||r.nightShift1!=null&&r.nightShift2!=null&&r.nightShift1===r.nightShift2){m("Ta sama osoba na obydwu zmianach.","red");return}const a=n.ratownik;let e=!1;switch(i){case"dayShift1":e=o.dayShift2Ratownik;break;case"dayShift2":e=o.dayShift1Ratownik;break;case"nightShift1":e=o.nightShift2Ratownik;break;case"nightShift2":e=o.nightShift1Ratownik;break}if(a&&e){m("Nie można przypisać dwóch ratowników na jedną zmianę.","red");return}o[i]=n.id,o[`${i}Name`]=n.name,o[`${i}Ratownik`]=n.ratownik,o[`${i}UserChanged`]=!0;const d={dayShift1:o.dayShift1,dayShift2:o.dayShift2,nightShift1:o.nightShift1,nightShift2:o.nightShift2};this.localData[t.toDateString()]=d,localStorage.setItem(t.toDateString(),JSON.stringify(d)),this.madeChanges=!0,this.$emit("has-changes",!0),localStorage.removeItem("draggedPerson")},handlePointerMove(t,i,n){this.currentDropTarget={date:i,shiftType:n},t.preventDefault()},handlePointerEnd(t,i,n){JSON.parse(localStorage.getItem("draggedPerson"))&&(this.handleDrop(i,n),this.currentDropTarget={date:null,shiftType:null})},isDropTarget(t,i){return this.currentDropTarget.date?this.currentDropTarget.date.toDateString()===t.toDateString()&&this.currentDropTarget.shiftType===i:!1},handleClickResetShift(t,i){if(t[i]!==null){t[i]=null,t[i+"Name"]="Usunięto",t[i+"Ratownik"]=null,t[i+"UserChanged"]=!0;const n={dayShift1:t.dayShift1,dayShift2:t.dayShift2,nightShift1:t.nightShift1,nightShift2:t.nightShift2};this.localData[t.date.toDateString()]=n,localStorage.setItem(t.date.toDateString(),JSON.stringify(n)),t[i]="Usunięto",this.madeChanges=!0,this.$emit("has-changes",!0)}},resolvePersonName(t){const i=this.people.find(n=>n.id===t);return i?{name:i.name,isRatownik:i.ratownik}:{name:void 0,isRatownik:!1}},generateMonthDays(){const t=this.selectedYear,i=this.selectedMonth,n=new Date(t,i+1,0).getDate();this.monthDays=[];for(let o=1;o<=n;o++)this.monthDays.push({date:new Date(t,i,o),dayShift1:null,dayShift2:null,nightShift1:null,nightShift2:null,dayShift1Name:"Not assigned",dayShift2Name:"Not assigned",nightShift1Name:"Not assigned",nightShift2Name:"Not assigned",isCurrentMonth:!0});this.loadFromLocalStorage(),this.$emit("month-days-updated",this.monthDays)},updateChanges(t){this.madeChanges=t,this.$emit("has-changes",t)},emitEditingMode(t){this.$emit("update-editing-mode",t)},async fetchServerShiftData(){this.syncedChanges={};try{const t=await fetch("https://mc.kot.li/?key=shiftData.json",{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw t.status===404&&m("Data not found on server","red"),new Error(`Failed to fetch data from server: ${t.status}`);return await t.json()}catch(t){return console.error("Error fetching data from server:",t),m("Failed to fetch data from server","red"),null}},async checkShiftDataSync(){this.resetSyncedChangesSessionStorage();const t=await this.fetchServerShiftData();if(!t){console.log("No remote data fetched.");return}const i={};for(const[n,o]of Object.entries(t)){const r=localStorage.getItem(n),a=r?JSON.parse(r):null,e={};if(!a)i[n]={...o},localStorage.setItem(n,JSON.stringify(o));else{for(const[d,s]of Object.entries(o)){const S=a[d]||null;S!==s&&(e[d]={from:S||"Empty",to:s||"Empty"})}Object.keys(e).length>0&&(i[n]=e),localStorage.setItem(n,JSON.stringify(o))}}this.generateMonthDays(),this.syncedChanges=i,sessionStorage.setItem("syncedChanges",JSON.stringify(this.syncedChanges)),setTimeout(()=>{this.syncedChanges={},sessionStorage.removeItem("syncedChanges")},5e3)},loadFromLocalStorage(){const t=this.selectedYear,i=this.selectedMonth;for(let n=1;n<=31;n++){const o=new Date(t,i,n).toDateString();if(this.syncedChanges[o])continue;const r=localStorage.getItem(o);if(r)try{const a=JSON.parse(r),e=this.monthDays.find(d=>d.date.toDateString()===o);if(e){e.dayShift1=a.dayShift1,e.dayShift2=a.dayShift2,e.nightShift1=a.nightShift1,e.nightShift2=a.nightShift2;const d=this.resolvePersonName(e.dayShift1);e.dayShift1Name=d.name,e.dayShift1Ratownik=d.isRatownik;const s=this.resolvePersonName(e.dayShift2);e.dayShift2Name=s.name,e.dayShift2Ratownik=s.isRatownik;const S=this.resolvePersonName(e.nightShift1);e.nightShift1Name=S.name,e.nightShift1Ratownik=S.isRatownik;const y=this.resolvePersonName(e.nightShift2);e.nightShift2Name=y.name,e.nightShift2Ratownik=y.isRatownik}}catch(a){m("Failed to load local data: "+a,"red")}}},resetSyncedChangesSessionStorage(){const t=sessionStorage.getItem("syncedChanges");t&&(this.syncedChanges=JSON.parse(t),setTimeout(()=>{this.syncedChanges={},sessionStorage.removeItem("syncedChanges")},5e3))},resetUserChanges(){for(const t in localStorage)if(localStorage.hasOwnProperty(t)){const i=JSON.parse(localStorage.getItem(t)||"{}");(i.dayShift1UserChanged||i.dayShift2UserChanged||i.nightShift1UserChanged||i.nightShift2UserChanged)&&localStorage.removeItem(t)}this.localData={},this.madeChanges=!1,this.$emit("has-changes",!1)},handleScroll(t){this.scrollContainer&&(t.preventDefault(),this.scrollContainer.scrollLeft+=t.deltaY)},getDayClass(t){return k[t]==="Nd"?"nd-color":k[t]==="Sob"?"sob-color":"normal-color"},getShiftAriaLabel(t,i){const n=t[i],o=i.includes("day")?"Zmiana dzienna":"Zmiana nocna",r=t[`${i}Name`];return this.isEditingMode?n?`${o}: ${r}. Kliknij aby usunąć zmianę.`:`${o}: Pusta zmiana. Przeciągnij członka zespołu by nadać im zmianę.`:n?`${o}: ${r}`:`${o}: Pusta zmiana.`},getShiftTooltip(t,i){const n=t[i],o=i.includes("day")?"Zmiana dzienna":"Zmiana nocna";return this.isEditingMode?n?`${o}: ${t[`${i}Name`]} (Kliknij by usunąć)`:`Przeciągnij członka zespołu by nadać im - ${o.toLowerCase()}`:n?`${o}: ${t[`${i}Name`]}`:`${o}: Nieprzypisana`},checkMobilePlatform(){const t=navigator.userAgent||navigator.vendor||window.opera;this.isMobileDevice=/android|iphone|ipad|ipod/i.test(t.toLowerCase())},handleMobileWarningClose(){this.showMobileWarning=!1,this.emitEditingMode(!1)},handlePointerUp(t){t.pointerType==="touch"&&(this.touchTimer&&(clearTimeout(this.touchTimer),this.touchTimer=null),this.touchedElement&&(this.touchedElement.releasePointerCapture(t.pointerId),this.touchedElement.classList.remove("being-touched")),this.isDragging=!1,this.touchedElement=null,this.touchedPerson=null)}},async mounted(){this.resetUserChanges(),await this.checkShiftDataSync(),this.scrollContainer=this.$refs.scrollContainer,this.checkMobilePlatform()},watch:{isEditingMode(t){localStorage.setItem("isEditingMode",JSON.stringify(t)),t&&this.isMobileDevice&&(this.showMobileWarning=!0)},selectedMonth(){this.generateMonthDays()},selectedYear(){this.generateMonthDays()}}},P={key:0,class:"mobile-warning-overlay"},M={class:"mobile-warning"},R={class:"calendar-container"},_={class:"calendar-grid"},E=["onDrop"],z={class:"day-header"},O=["onDrop"],U={class:"day-date"},I=["clickable","onDrop","onPointerup","onPointermove","onClick","aria-label","title"],T={key:0,class:"assigned-person"},j={key:1,class:"empty-slot"},W=["clickable","onDrop","onPointerup","onPointermove","onClick","aria-label","title"],L={key:0,class:"assigned-person"},J={key:1,class:"empty-slot"},A=["onDrop","onPointerup","onPointermove","onClick","aria-label","title"],F={key:0,class:"assigned-person"},x={key:1,class:"empty-slot"},Y=["clickable","onDrop","onPointerup","onPointermove","onClick","aria-label","title"],q={key:0,class:"assigned-person"},B={key:1,class:"empty-slot"};function Z(t,i,n,o,r,a){return g(),c(D,null,[r.showMobileWarning?(g(),c("div",P,[h("div",M,[i[7]||(i[7]=h("h3",null,"!! Urządzenie mobilne wykryte !!",-1)),i[8]||(i[8]=h("p",null," Niestety, tryb edycji w widoku kalendarza nie jest obsługiwany na urządzeniach mobilnych. ",-1)),i[9]||(i[9]=h("p",null,"Proszę przejdź do widoku tabeli lub skorzystaj z komputera.",-1)),h("button",{onClick:i[0]||(i[0]=(...e)=>a.handleMobileWarningClose&&a.handleMobileWarningClose(...e)),class:"warning-button"}," Ok :( ")])])):p("",!0),h("div",R,[h("section",{class:"scrollable-container",onWheel:i[6]||(i[6]=l((...e)=>a.handleScroll&&a.handleScroll(...e),["prevent"])),ref:"scrollContainer"},[h("div",_,[(g(!0),c(D,null,C(r.monthDays,(e,d)=>(g(),c("div",{key:d,class:"day-column",onDragover:i[5]||(i[5]=l(()=>{},["prevent"])),onDrop:s=>a.handleDrop(e.date,"day")},[h("div",null,[h("div",{class:u(["day-cell",{"current-month":e.isCurrentMonth,"nd-color":r.daysOfWeek[e.date.getDay()]==="Nd","sob-color":r.daysOfWeek[e.date.getDay()]==="Sob"}])},[h("div",z,f(r.daysOfWeek[e.date.getDay()]),1),h("div",{class:"shift",onDrop:s=>a.handleDrop(e.date,"day"),onDragover:i[4]||(i[4]=l(()=>{},["prevent"]))},[h("div",U,f(e.date.getDate()),1),h("div",{class:u(["shift-slot day",{"synced-changed":r.syncedChanges[e.date.toDateString()]?.dayShift1,ratownik:e.dayShift1Ratownik===!0,pielegniarka:e.dayShift1Ratownik===!1,userChanged:e.dayShift1UserChanged===!0,clickable:n.isEditingMode}]),clickable:n.isEditingMode,onDragover:i[1]||(i[1]=l(()=>{},["prevent"])),onDrop:s=>a.handleDrop(e.date,"dayShift1"),onPointerup:l(s=>a.handlePointerUp(s,e.date,"dayShift1"),["prevent"]),onPointermove:l(s=>a.handlePointerMove(s,e.date,"dayShift1"),["prevent"]),onClick:s=>n.isEditingMode&&a.handleClickResetShift(e,"dayShift1"),"aria-label":a.getShiftAriaLabel(e,"dayShift1"),title:a.getShiftTooltip(e,"dayShift1"),role:"button",tabindex:"0"},[e.dayShift1?(g(),c("div",T,f(e.dayShift1Name),1)):(g(),c("div",j,"D"))],42,I),h("div",{class:u(["shift-slot day",{"synced-changed":r.syncedChanges[e.date.toDateString()]?.dayShift2,ratownik:e.dayShift2Ratownik===!0,pielegniarka:e.dayShift2Ratownik===!1,userChanged:e.dayShift2UserChanged===!0,clickable:n.isEditingMode}]),clickable:n.isEditingMode,onDrop:s=>a.handleDrop(e.date,"dayShift2"),onPointerup:l(s=>a.handlePointerUp(s,e.date,"dayShift2"),["prevent"]),onPointermove:l(s=>a.handlePointerMove(s,e.date,"dayShift2"),["prevent"]),onClick:s=>n.isEditingMode&&a.handleClickResetShift(e,"dayShift2"),"aria-label":a.getShiftAriaLabel(e,"dayShift2"),title:a.getShiftTooltip(e,"dayShift2"),role:"button",tabindex:"0"},[e.dayShift2?(g(),c("div",L,f(e.dayShift2Name),1)):(g(),c("div",J,"D"))],42,W),h("div",{class:u(["shift-slot night",{"synced-changed":r.syncedChanges[e.date.toDateString()]?.nightShift1,ratownik:e.nightShift1Ratownik===!0,pielegniarka:e.nightShift1Ratownik===!1,userChanged:e.nightShift1UserChanged===!0,clickable:n.isEditingMode}]),onDragover:i[2]||(i[2]=l(()=>{},["prevent"])),onDrop:s=>a.handleDrop(e.date,"nightShift1"),onPointerup:l(s=>a.handlePointerUp(s,e.date,"nightShift1"),["prevent"]),onPointermove:l(s=>a.handlePointerMove(s,e.date,"nightShift1"),["prevent"]),onClick:s=>n.isEditingMode&&a.handleClickResetShift(e,"nightShift1"),"aria-label":a.getShiftAriaLabel(e,"nightShift1"),title:a.getShiftTooltip(e,"nightShift1"),role:"button",tabindex:"0"},[e.nightShift1?(g(),c("div",F,f(e.nightShift1Name),1)):(g(),c("div",x,"N"))],42,A),h("div",{class:u(["shift-slot night",{"synced-changed":r.syncedChanges[e.date.toDateString()]?.nightShift2,ratownik:e.nightShift2Ratownik===!0,pielegniarka:e.nightShift2Ratownik===!1,userChanged:e.nightShift2UserChanged===!0,clickable:n.isEditingMode}]),clickable:n.isEditingMode,onDragover:i[3]||(i[3]=l(()=>{},["prevent"])),onDrop:s=>a.handleDrop(e.date,"nightShift2"),onPointerup:l(s=>a.handlePointerUp(s,e.date,"nightShift2"),["prevent"]),onPointermove:l(s=>a.handlePointerMove(s,e.date,"nightShift2"),["prevent"]),onClick:s=>n.isEditingMode&&a.handleClickResetShift(e,"nightShift2"),"aria-label":a.getShiftAriaLabel(e,"nightShift2"),title:a.getShiftTooltip(e,"nightShift2"),role:"button",tabindex:"0"},[e.nightShift2?(g(),c("div",q,f(e.nightShift2Name),1)):(g(),c("div",B,"N"))],42,Y)],40,O)],2)])],40,E))),128))])],544)])],64)}const Q=v(N,[["render",Z],["__scopeId","data-v-2c239723"]]);export{Q as default};
