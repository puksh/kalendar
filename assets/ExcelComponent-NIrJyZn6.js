import{d as p}from"./daysOfWeek-C19XqJ9X.js";import{_ as M,N as v,a as g,c as b,r as U}from"./utils-BV2iPCIX.js";import{c as f,d as o,F as y,a as u,l as O,o as S,n as N,t as D,w as z,s as _}from"./vue-vendor-BNAjV1iG.js";const P={name:"SpreadsheetView",emits:["update-editing-mode","has-changes","month-days-updated"],props:{isEditingMode:{type:Boolean,required:!0},selectedMonth:{type:Number,required:!0},selectedYear:{type:Number,required:!0},people:{type:Array,required:!0}},components:{NotificationMessage:v},data(){return{editedShifts:{},monthDays:[],localData:{},daysOfWeek:p,madeChanges:!1,scrollContainer:null}},computed:{daysInMonth(){return this.monthDays.map(e=>e.date.getDate())},orderedPeople(){const e=["Milena","Mikołaj","Aleksandra","Joanna","Łukasz","Natalia","Marcin"];return this.people.filter(i=>e.includes(i.name)).sort((i,a)=>e.indexOf(i.name)-e.indexOf(a.name))}},watch:{selectedMonth(){this.generateMonthDays()},selectedYear(){this.generateMonthDays()}},methods:{isEditing(e,i){return this.editedShifts.hasOwnProperty(`${e}-${i}`)},getShiftForPersonAndDay(e,i){const a=this.monthDays.find(h=>h.date.getDate()===i)?.date.toDateString(),d=localStorage.getItem(a);if(d){const h=JSON.parse(d),s=[];return(h.dayShift1===e||h.dayShift2===e)&&s.push("D"),(h.nightShift1===e||h.nightShift2===e)&&s.push("N"),s.join(" ")}return null},editCell(e,i){if(this.isEditingMode){const a=`${e}-${i}`,d=this.getShiftForPersonAndDay(e,i)||"";this.editedShifts[a]=d}},saveShift(e,i){const a=`${e}-${i}`,d=this.editedShifts[a]?.trim().toUpperCase()||"",h=this.getShiftForPersonAndDay(e,i)||"";if(!["D","N","D N",""].includes(d)){g("Zła wartość! Tylko 'D', 'N', lub 'D N' są dozwolone."),this.$nextTick(()=>{this.editedShifts[a]=h});return}const n=this.monthDays.find(l=>l.date.getDate()===i)?.date.toDateString();if(!n||!this.monthDays)return;const t=this.monthDays.find(l=>l.date.toDateString()===n);if(!t)return;if(t.dayShift1===e&&(t.dayShift1=null,t.dayShift1Name="Not assigned",t.dayShift1UserChanged=!0),t.dayShift2===e&&(t.dayShift2=null,t.dayShift2Name="Not assigned",t.dayShift2UserChanged=!0),t.nightShift1===e&&(t.nightShift1=null,t.nightShift1Name="Not assigned",t.nightShift1UserChanged=!0),t.nightShift2===e&&(t.nightShift2=null,t.nightShift2Name="Not assigned",t.nightShift2UserChanged=!0),d===""){const l={dayShift1:t.dayShift1,dayShift2:t.dayShift2,nightShift1:t.nightShift1,nightShift2:t.nightShift2,dayShift1Name:t.dayShift1Name,dayShift2Name:t.dayShift2Name,nightShift1Name:t.nightShift1Name,nightShift2Name:t.nightShift2Name};this.localData[n]=l,localStorage.setItem(n,JSON.stringify(l)),this.madeChanges=!0,this.$emit("has-changes",this.madeChanges),this.$nextTick(()=>{delete this.editedShifts[a],this.$forceUpdate()});return}const r=this.people.find(l=>l.id===e);if(d.includes("D")){if(r?.ratownik&&[t.dayShift1,t.dayShift2].filter(Boolean).some(c=>this.people.find(m=>m.id===c)?.ratownik&&c!==e)){g("Nie można przypisać dwóch ratowników na zmianę dzienną."),delete this.editedShifts[a];return}if(!t.dayShift1)t.dayShift1=e,t.dayShift1Name=r.name,t.dayShift1UserChanged=!0;else if(!t.dayShift2)t.dayShift2=e,t.dayShift2Name=r.name,t.dayShift2UserChanged=!0;else{g("Nie można przypisać więcej niż dwóch osób na zmianę dzienną."),delete this.editedShifts[a];return}}if(d.includes("N")){if(r?.ratownik&&[t.nightShift1,t.nightShift2].filter(Boolean).some(c=>this.people.find(m=>m.id===c)?.ratownik&&c!==e)){g("Nie można przypisać dwóch ratowników na zmianę nocną."),delete this.editedShifts[a];return}if(!t.nightShift1)t.nightShift1=e,t.nightShift1Name=r.name,t.nightShift1UserChanged=!0;else if(!t.nightShift2)t.nightShift2=e,t.nightShift2Name=r.name,t.nightShift2UserChanged=!0;else{g("Nie można przypisać więcej niż dwóch osób na zmianę nocną."),delete this.editedShifts[a];return}}const w={dayShift1:t.dayShift1,dayShift2:t.dayShift2,nightShift1:t.nightShift1,nightShift2:t.nightShift2};this.localData[n]=w,this.madeChanges=!0,this.$emit("has-changes",this.madeChanges),localStorage.setItem(n,JSON.stringify(w)),delete this.editedShifts[a]},generateMonthDays(){this.resetUserChanges();const e=this.selectedYear,i=this.selectedMonth,a=new Date(e,i+1,0).getDate();this.monthDays=[];for(let d=1;d<=a;d++)this.monthDays.push({date:new Date(e,i,d),dayShift1:null,dayShift2:null,nightShift1:null,nightShift2:null,dayShift1Name:"Not assigned",dayShift2Name:"Not assigned",nightShift1Name:"Not assigned",nightShift2Name:"Not assigned",isCurrentMonth:!0});this.loadFromLocalStorage(),this.$emit("month-days-updated",this.monthDays)},updateChanges(e){this.madeChanges=e,this.$emit("has-changes",this.madeChanges)},loadFromLocalStorage(){const e=this.selectedYear,i=this.selectedMonth;for(let a=1;a<=31;a++){const d=new Date(e,i,a).toDateString(),h=localStorage.getItem(d);if(h)try{const s=JSON.parse(h),n=this.monthDays.find(t=>t.date.toDateString()===d);n&&(n.dayShift1=s.dayShift1,n.dayShift2=s.dayShift2,n.nightShift1=s.nightShift1,n.nightShift2=s.nightShift2,n.dayShift1Name=s.dayShift1Name||"Not assigned",n.dayShift2Name=s.dayShift2Name||"Not assigned",n.nightShift1Name=s.nightShift1Name||"Not assigned",n.nightShift2Name=s.nightShift2Name||"Not assigned")}catch{g("Nie udało się załadować danych lokalnych. Sprawdź konsolę.","red")}}},resolvePersonName(e){const i=this.people.find(a=>a.id===e);return i?{name:i.name,isRatownik:i.ratownik}:{name:void 0,isRatownik:!1}},async checkShiftDataSync(){this.syncedChanges=await b(()=>this.generateMonthDays())},resetSyncedChangesSessionStorage(){this.syncedChanges=U()},handleScroll(e){this.scrollContainer&&(e.preventDefault(),this.scrollContainer.scrollLeft+=e.deltaY)},resetUserChanges(){for(const e in localStorage)if(localStorage.hasOwnProperty(e)){const i=JSON.parse(localStorage.getItem(e)||"{}");(i.dayShift1UserChanged||i.dayShift2UserChanged||i.nightShift1UserChanged||i.nightShift2UserChanged)&&localStorage.removeItem(e)}this.localData={},this.madeChanges=!1,this.$emit("has-changes",this.madeChanges),this.editedShifts={}}},mounted(){this.resetUserChanges(),this.generateMonthDays(),this.scrollContainer=this.$refs.scrollContainer}},E={class:"spreadsheet-view"},F={class:"calendar-table"},V=["onClick","aria-label","title"],Y={key:0},x=["onUpdate:modelValue","onChange"];function j(e,i,a,d,h,s){return S(),f("div",E,[o("div",{class:"scrollable-container",onWheel:i[0]||(i[0]=O((...n)=>s.handleScroll&&s.handleScroll(...n),["prevent"])),ref:"scrollContainer"},[o("table",F,[o("thead",null,[o("tr",null,[i[1]||(i[1]=o("th",null,null,-1)),(S(!0),f(y,null,u(s.daysInMonth,n=>(S(),f("th",{key:n,class:N({"nd-color":h.daysOfWeek[new Date(a.selectedYear,a.selectedMonth,n).getDay()]==="Nd","sob-color":h.daysOfWeek[new Date(a.selectedYear,a.selectedMonth,n).getDay()]==="Sob"})},D(n),3))),128))])]),o("tbody",null,[(S(!0),f(y,null,u(s.orderedPeople,n=>(S(),f("tr",{key:n.id},[o("td",{class:N({ratownik:n.ratownik,pielegniarka:!n.ratownik})},D(n.name),3),(S(!0),f(y,null,u(s.daysInMonth,t=>(S(),f("td",{key:t,class:N(["editable-cell",{"nd-color":h.daysOfWeek[new Date(a.selectedYear,a.selectedMonth,t).getDay()]==="Nd","sob-color":h.daysOfWeek[new Date(a.selectedYear,a.selectedMonth,t).getDay()]==="Sob"}]),onClick:r=>s.editCell(n.id,t),"aria-label":a.isEditingMode?"Kliknij aby edytować zmianę":"",title:a.isEditingMode?"Kliknij aby edytować zmianę":"",role:"gridcell"},[!a.isEditingMode||!s.isEditing(n.id,t)?(S(),f("span",Y,D(s.getShiftForPersonAndDay(n.id,t)||""),1)):z((S(),f("select",{key:1,"onUpdate:modelValue":r=>h.editedShifts[`${n.id}-${t}`]=r,onChange:r=>s.saveShift(n.id,t)},i[2]||(i[2]=[o("option",{value:""},null,-1),o("option",{value:"D"},"D",-1),o("option",{value:"N"},"N",-1),o("option",{value:"D N"},"D N",-1)]),40,x)),[[_,h.editedShifts[`${n.id}-${t}`]]])],10,V))),128))]))),128))])])],544)])}const R=M(P,[["render",j],["__scopeId","data-v-1ce33b4c"]]);export{R as default};
